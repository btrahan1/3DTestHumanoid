@page "/humanoid"
@using _3DTestHumanoid.Main.Client
@using System.Text.Json
@inject IJSRuntime JS

<PageTitle>Humanoid Generator</PageTitle>

<div class="container-fluid">
    <div class="row">
        <!-- Controls Sidebar -->
        <div class="col-md-3 bg-light p-3" style="height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">

            <h4 class="mb-3">Character Recipe</h4>

            <!-- Recipe Name -->
            <div class="mb-3">
                <label class="form-label small">Name</label>
                <input type="text" class="form-control" @bind="recipe.Name" />
            </div>

            <!-- RECIPE ACTIONS -->
            <div class="d-grid gap-2 mb-4">
                 <div class="btn-group">
                    <label class="btn btn-outline-secondary btn-sm" title="Load Recipe (.json)">
                        <span class="bi bi-upload"></span> Load Recipe
                        <InputFile OnChange="OnLoadRecipe" style="display: none;" accept=".json" />
                    </label>
                    <button class="btn btn-outline-primary btn-sm" @onclick="SaveRecipe" title="Save Recipe (.json)">
                        <span class="bi bi-save"></span> Save Recipe
                    </button>
                    <button class="btn btn-outline-danger btn-sm" @onclick="ResetRecipe" title="Reset">
                        <span class="bi bi-arrow-counterclockwise"></span>
                    </button>
                 </div>
            </div>
            
            <hr />

            <!-- AI / PASTEBOARD SECTION -->
            <details class="mb-3">
                <summary class="small">AI / Pasteboard</summary>
                <div class="mt-2">
                    <textarea class="form-control x-small mb-2" rows="5" placeholder="Paste JSON here..." @bind="pasteJson"></textarea>
                    <button class="btn btn-sm btn-outline-primary w-100" @onclick="ApplyPaste">
                        <span class="bi bi-magic"></span> Apply Recipe
                    </button>
                    @if (!string.IsNullOrEmpty(pasteError))
                    {
                        <div class="text-danger x-small mt-1">@pasteError</div>
                    }
                </div>
            </details>

            <hr />

            <!-- FACIAL FEATURES -->
            <!-- FACIAL FEATURES -->
            <details open class="mb-3">
                <summary class="h5">Face</summary>
                <div class="mt-2">
                    <div class="row g-2 mb-3">
                         <div class="col-6">
                            <label class="form-label x-small">Hair</label>
                            <select class="form-select form-select-sm" @bind="recipe.HairStyle" @bind:after="Render">
                                <option value="None">None</option>
                                <option value="Short">Short</option>
                                <option value="Long">Long</option>
                                <option value="Mohawk">Mohawk</option>
                            </select>
                         </div>
                         <div class="col-6">
                            <label class="form-label x-small">Beard</label>
                            <select class="form-select form-select-sm" @bind="recipe.BeardStyle" @bind:after="Render">
                                <option value="None">None</option>
                                <option value="Goatee">Goatee</option>
                                <option value="Full">Full</option>
                            </select>
                         </div>
                    </div>
                    <div class="row g-2 mb-3">
                         <div class="col-6">
                            <label class="form-label x-small">Hair Color</label>
                            <input type="color" class="form-control form-control-sm form-control-color w-100" @bind="recipe.HairColor" @bind:after="Render" />
                         </div>
                         <div class="col-6">
                            <label class="form-label x-small">Eye Color</label>
                            <input type="color" class="form-control form-control-sm form-control-color w-100" @bind="recipe.EyeColor" @bind:after="Render" />
                         </div>
                    </div>
                    <div class="row g-2 mb-3">
                         <div class="col-6">
                            <label class="form-label x-small">Eyebrow Color</label>
                            <input type="color" class="form-control form-control-sm form-control-color w-100" @bind="recipe.EyebrowColor" @bind:after="Render" />
                         </div>
                         <div class="col-6 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkEars" @bind="recipe.HasEars" @bind:after="Render">
                                <label class="form-check-label x-small" for="chkEars">Has Ears</label>
                            </div>
                         </div>
                    </div>

                    <div class="row g-1 border-top pt-2">
                         <div class="col-6 mb-2">
                            <label class="form-label x-small">Eye Depth: <strong>@recipe.EyeDepth.ToString("0.00")</strong></label>
                            <input type="range" class="form-range" min="0.5" max="2.0" step="0.01"
                                   @bind="recipe.EyeDepth" @bind:event="oninput" @onchange="Render" />
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label x-small">Nose Depth: <strong>@recipe.NoseDepth.ToString("0.00")</strong></label>
                            <input type="range" class="form-range" min="0.5" max="2.0" step="0.01"
                                   @bind="recipe.NoseDepth" @bind:event="oninput" @onchange="Render" />
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label x-small">Brow Depth: <strong>@recipe.BrowDepth.ToString("0.00")</strong></label>
                            <input type="range" class="form-range" min="0.5" max="2.0" step="0.01"
                                   @bind="recipe.BrowDepth" @bind:event="oninput" @onchange="Render" />
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label x-small">Mouth Depth: <strong>@recipe.MouthDepth.ToString("0.00")</strong></label>
                            <input type="range" class="form-range" min="0.5" max="2.0" step="0.01"
                                   @bind="recipe.MouthDepth" @bind:event="oninput" @onchange="Render" />
                        </div>
                    </div>
                </div>
            </details>

            <hr />

            <!-- APPEARANCE SECTION -->
            <!-- APPEARANCE SECTION -->
            <details class="mb-3">
                <summary class="h5">Equipment</summary>
                <div class="mt-2">
                    <div class="mb-3">
                        <label class="form-label small">Skin Tone</label>
                        <input type="color" class="form-control form-control-color w-100"
                               @bind="recipe.SkinColor" @bind:event="oninput" @onchange="Render" />
                    </div>

                    <!-- ARMOR SLOTS -->
                    <h6 class="mb-2 text-muted x-small">Armor</h6>
                    <div class="mb-2">
                        <label class="form-label x-small">Head</label>
                        <select class="form-select form-select-sm" @bind="recipe.HeadSlot" @bind:after="Render">
                            <option value="None">None</option>
                            <option value="ClothHood">Cloth Hood</option>
                            <option value="LeatherHelm">Leather Helm</option>
                            <option value="ChainHood">Chain Hood</option>
                            <option value="PlateHelm">Plate Helm</option>
                        </select>
                    </div>
                    <div class="mb-2">
                         <label class="form-label x-small">Shoulders</label>
                        <select class="form-select form-select-sm" @bind="recipe.ShouldersSlot" @bind:after="Render">
                            <option value="None">None</option>
                            <option value="ClothPauldrons">Cloth Mantle</option>
                            <option value="LeatherPauldrons">Leather Pauldrons</option>
                            <option value="ChainPauldrons">Chain Mantle</option>
                            <option value="PlatePauldrons">Plate Pauldrons</option>
                        </select>
                    </div>
                    <div class="mb-2">
                         <label class="form-label x-small">Chest</label>
                        <select class="form-select form-select-sm" @bind="recipe.TorsoSlot" @bind:after="Render">
                            <option value="None">None</option>
                            <option value="Shirt">Shirt (Cloth)</option>
                            <option value="LeatherVest">Leather Vest</option>
                            <option value="Chainmail">Chainmail</option>
                            <option value="PlateArmor">Plate Armor</option>
                        </select>
                    </div>
                     <div class="mb-2">
                         <label class="form-label x-small">Arms</label>
                        <select class="form-select form-select-sm" @bind="recipe.ArmsSlot" @bind:after="Render">
                            <option value="None">None</option>
                            <option value="ClothSleeves">Cloth Sleeves</option>
                            <option value="LeatherBracers">Leather Arms</option>
                            <option value="ChainSleeves">Chain Sleeves</option>
                            <option value="PlateVambraces">Plate Vambraces</option>
                        </select>
                    </div>
                     <div class="mb-2">
                         <label class="form-label x-small">Hands</label>
                        <select class="form-select form-select-sm" @bind="recipe.HandsSlot" @bind:after="Render">
                            <option value="None">None</option>
                            <option value="ClothGloves">Cloth Gloves</option>
                            <option value="LeatherGloves">Leather Gloves</option>
                            <option value="ChainGloves">Chain Gloves</option>
                            <option value="PlateGauntlets">Plate Gauntlets</option>
                        </select>
                    </div>
                    <div class="mb-2">
                         <label class="form-label x-small">Legs</label>
                        <select class="form-select form-select-sm" @bind="recipe.LegsSlot" @bind:after="Render">
                            <option value="None">None</option>
                            <option value="Pants">Pants (Cloth)</option>
                            <option value="LeatherChaps">Leather Chaps</option>
                            <option value="ChainLegs">Chain Legs</option>
                            <option value="PlateGreaves">Plate Greaves</option>
                        </select>
                    </div>
                    <div class="mb-2">
                         <label class="form-label x-small">Feet</label>
                        <select class="form-select form-select-sm" @bind="recipe.FeetSlot" @bind:after="Render">
                            <option value="None">None</option>
                            <option value="ClothShoes">Cloth Shoes</option>
                            <option value="Boots">Boots (Leather)</option>
                            <option value="ChainBoots">Chain Boots</option>
                            <option value="PlateBoots">Plate Boots</option>
                        </select>
                    </div>
                </div>
            </details>

            <!-- MORPHOLOGY SECTION -->
            <details class="mb-3">
                <summary class="h5">Morphology</summary>
                <div class="mt-2">
                    <div class="mb-3">
                        <label class="form-label small">Body Type</label>
                        <select class="form-select" @bind="recipe.BodyType" @bind:after="Render">
                            <option value="Average">Average</option>
                            <option value="Heavy">Heavy (Tank)</option>
                            <option value="Lean">Lean (Speed)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small">Height Scale: <strong>@recipe.HeightScale.ToString("0.0")x</strong></label>
                        <input type="range" class="form-range" min="0.5" max="2.0" step="0.1"
                               @bind="recipe.HeightScale" @bind:event="oninput" @onchange="Render" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">Width/Weight: <strong>@recipe.WidthScale.ToString("0.0")x</strong></label>
                        <input type="range" class="form-range" min="0.5" max="2.0" step="0.1"
                               @bind="recipe.WidthScale" @bind:event="oninput" @onchange="Render" />
                    </div>

                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label x-small">Shoulders</label>
                            <input type="range" class="form-range" min="0.5" max="2.0" step="0.1"
                                   @bind="recipe.ShoulderWidth" @bind:event="oninput" @onchange="Render" />
                        </div>
                        <div class="col-6 mb-2">
                             <label class="form-label x-small">Head</label>
                            <input type="range" class="form-range" min="0.5" max="2.0" step="0.1"
                                   @bind="recipe.HeadSize" @bind:event="oninput" @onchange="Render" />
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label x-small">Arms</label>
                            <input type="range" class="form-range" min="0.8" max="1.5" step="0.05"
                                   @bind="recipe.ArmLength" @bind:event="oninput" @onchange="Render" />
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label x-small">Legs</label>
                            <input type="range" class="form-range" min="0.8" max="1.5" step="0.05"
                                   @bind="recipe.LegLength" @bind:event="oninput" @onchange="Render" />
                        </div>
                    </div>
                </div>
            </details>
            
            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" @bind="xRayMode" @onclick="ToggleXRay">
                <label class="form-check-label">X-Ray Mode</label>
            </div>

            <!-- ARSENAL -->
            <details class="mb-3">
                <summary class="h5 mt-4 mb-2">Arsenal</summary>
                <div class="mt-2">
                    <div class="row mb-3">
                         <div class="col-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkSword" @bind="recipe.HasSword" @bind:after="Render">
                                <label class="form-check-label" for="chkSword">Sword</label>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkShield" @bind="recipe.HasShield" @bind:after="Render">
                                <label class="form-check-label" for="chkShield">Shield</label>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkSpear" @bind="recipe.HasSpear" @bind:after="Render">
                                <label class="form-check-label" for="chkSpear">Spear</label>
                            </div>
                        </div>
                    </div>
                </div>
            </details>

            <div style="flex-grow: 1;"></div>
            
            <!-- MODEL ACTIONS -->
            <h5 class="mb-2">3D Model</h5>
            <div class="d-grid gap-2 mt-auto">
                <button class="btn btn-outline-secondary btn-sm" @onclick="LoadFbx">
                     <span class="bi bi-arrow-repeat"></span> Reset Base Model
                </button>
                
                <label class="btn btn-outline-secondary btn-sm">
                    <span class="bi bi-file-earmark-binary"></span> Import .GLB Mesh
                    <InputFile OnChange="OnLoadGlb" style="display: none;" accept=".glb,.gltf" />
                </label>

                <button class="btn btn-success" @onclick="DownloadGlb">
                    <span class="bi bi-download"></span> Export Model (.GLB)
                </button>
            </div>

        </div>

        <!-- 3D Canvas -->
        <div class="col-md-9 p-0">
            <canvas id="renderCanvas" style="width: 100%; height: 90vh; outline: none; display: block;"></canvas>
        </div>
    </div>
</div>

@code {
    private IJSObjectReference? module;
    private HumanoidRecipe recipe = new HumanoidRecipe();
    private bool isWalking = false;
    private bool xRayMode = false;
    
    // Pasteboard
    private string pasteJson = "";
    private string pasteError = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/humanoidRenderer.js?v=8");
                await module.InvokeVoidAsync("initCanvas", "renderCanvas");
                await Render();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing 3D Scene: {ex.Message}");
            }
        }
    }

    private async Task Render()
    {
        if (module is not null)
        {
            // Update Visuals (Disable procedural body, keep equipment/armor flags)
            await module.InvokeVoidAsync("renderHumanoid", HumanoidSolver.Solve(recipe, false));
            await module.InvokeVoidAsync("setBodyScale", recipe.HeightScale, recipe.WidthScale);
            
            // Calculate Thickness derived from BodyType
            float thickness = 1.0f;
            if (recipe.BodyType.Equals("Heavy", StringComparison.OrdinalIgnoreCase)) thickness = 1.30f;
            else if (recipe.BodyType.Equals("Lean", StringComparison.OrdinalIgnoreCase)) thickness = 0.85f;

            await module.InvokeVoidAsync("setMorphology", recipe.ShoulderWidth, recipe.LegLength, recipe.ArmLength, recipe.HeadSize, thickness);
            await module.InvokeVoidAsync("setSkinColor", recipe.SkinColor);
        }
    }

    // --- RECIPE MANAGEMENT ---

    private void ResetRecipe()
    {
        recipe = new HumanoidRecipe();
        pasteJson = "";
        pasteError = "";
        StateHasChanged();
        _ = Render();
    }

    private async Task ApplyPaste()
    {
        if (string.IsNullOrWhiteSpace(pasteJson)) return;
        try 
        {
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var newRecipe = JsonSerializer.Deserialize<HumanoidRecipe>(pasteJson, options);
            if (newRecipe != null)
            {
                recipe = newRecipe;
                pasteError = "";
                await Render();
            }
        }
        catch (Exception ex)
        {
            pasteError = "Invalid JSON";
            Console.WriteLine(ex.Message);
        }
    }

    private async Task SaveRecipe()
    {
        var json = JsonSerializer.Serialize(recipe, new JsonSerializerOptions { WriteIndented = true });
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);
        var filename = $"{recipe.Name.Replace(" ", "_")}.json";
        
        // Use module instance for exported functions
        if (module is not null)
        {
            await module.InvokeVoidAsync("downloadFileFromClient", filename, base64);
        }
    }

    private async Task OnLoadRecipe(InputFileChangeEventArgs e)
    {
        try {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            recipe = await JsonSerializer.DeserializeAsync<HumanoidRecipe>(stream) ?? new HumanoidRecipe();
            await Render();
        } catch (Exception ex) {
            Console.WriteLine("Error loading recipe: " + ex.Message);
        }
    }

    // --- MODEL IO ---

    private async Task OnLoadGlb(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        using var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        await module.InvokeVoidAsync("loadGlbModel", ms.ToArray());
    }

    private async Task LoadFbx()
    {
        if (module is not null)
        {
            await module.InvokeVoidAsync("loadHumanoidFbx");
            await Render();
        }
    }

    private async Task DownloadGlb()
    {
        if (module is not null)
        {
            string filename = $"{recipe.Name}_Export";
            await module.InvokeVoidAsync("downloadModel", filename);
        }
    }
    
    // --- VIEW CONTROLS ---

    private async Task ToggleXRay()
    {
        xRayMode = !xRayMode;
        if (module is not null) await module.InvokeVoidAsync("setXRayMode", xRayMode);
    }
}
