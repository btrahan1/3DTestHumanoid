@page "/humanoid"
@using _3DTestHumanoid.Main.Client
@inject IJSRuntime JS

<PageTitle>Humanoid Generator</PageTitle>

<div class="container-fluid">
    <div class="row">
        <!-- Controls Sidebar -->
        <div class="col-md-3 bg-light p-3" style="height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">

            <!-- GENETICS SECTION -->
            <h4 class="mb-3">Genetics</h4>

            <div class="mb-4">
                <label class="form-label small">Race Preset</label>
                <select class="form-select form-select-sm" @onchange="OnRaceChanged">
                    <option value="human">Human</option>
                    <option value="orc">Orc</option>
                    <option value="elf">Elf</option>
                    <option value="werewolf">Werewolf</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label small">Height: <strong>@recipe.HeightCm cm</strong></label>
                <input type="range" class="form-range" min="140" max="220"
                       @bind="recipe.HeightCm" @bind:event="oninput" @onchange="Render" />
            </div>

            <div class="mb-3">
                <label class="form-label small">Muscularity: <strong>@recipe.Muscularity.ToString("0.0")</strong></label>
                <input type="range" class="form-range" min="0" max="1" step="0.1"
                       @bind="recipe.Muscularity" @bind:event="oninput" @onchange="Render" />
            </div>

            <div class="mb-3">
                <label class="form-label small">Obesity: <strong>@recipe.Obesity.ToString("0.0")</strong></label>
                <input type="range" class="form-range" min="0" max="1" step="0.1"
                       @bind="recipe.Obesity" @bind:event="oninput" @onchange="Render" />
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" @bind="recipe.IsMale" @onclick="ToggleGender">
                <label class="form-check-label">Is Male Frame</label>
            </div>

            <!-- ADVANCED MORPHOLOGY SECTION -->
            <div class="accordion mb-3" id="morphologyAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button @(showAdvanced ? "" : "collapsed") py-2 small" type="button" @onclick="() => showAdvanced = !showAdvanced">
                            Advanced Morphology
                        </button>
                    </h2>
                    <div class="accordion-collapse collapse @(showAdvanced ? "show" : "")">
                        <div class="accordion-body p-2">
                            <div class="mb-2">
                                <label class="form-label x-small d-block mb-1">Shoulder Width: <strong>@recipe.ShoulderWidthMult.ToString("0.0")x</strong></label>
                                <input type="range" class="form-range" min="0.8" max="2.0" step="0.1" 
                                       @bind="recipe.ShoulderWidthMult" @bind:event="oninput" @onchange="Render" />
                            </div>
                            <div class="mb-2">
                                <label class="form-label x-small d-block mb-1">Arm Length: <strong>@recipe.ArmLengthMult.ToString("0.0")x</strong></label>
                                <input type="range" class="form-range" min="0.8" max="1.5" step="0.1" 
                                       @bind="recipe.ArmLengthMult" @bind:event="oninput" @onchange="Render" />
                            </div>
                            <div class="mb-2">
                                <label class="form-label x-small d-block mb-1">Leg Length: <strong>@recipe.LegLengthMult.ToString("0.0")x</strong></label>
                                <input type="range" class="form-range" min="0.8" max="1.5" step="0.1" 
                                       @bind="recipe.LegLengthMult" @bind:event="oninput" @onchange="Render" />
                            </div>
                            <div class="mb-2">
                                <label class="form-label x-small d-block mb-1">Hunch: <strong>@recipe.TorsoHunch.ToString("0.0")</strong></label>
                                <input type="range" class="form-range" min="0" max="1" step="0.1" 
                                       @bind="recipe.TorsoHunch" @bind:event="oninput" @onchange="Render" />
                            </div>
                            <div class="mb-0">
                                <label class="form-label x-small d-block mb-1">Neck Length: <strong>@recipe.NeckLengthMult.ToString("0.0")x</strong></label>
                                <input type="range" class="form-range" min="0.5" max="2.0" step="0.1" 
                                       @bind="recipe.NeckLengthMult" @bind:event="oninput" @onchange="Render" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .x-small { font-size: 0.75rem; }
            </style>

            <!-- Primary Action Button -->
            <button class="btn btn-primary w-100 mb-2" @onclick="Render">
                <span class="bi bi-arrow-clockwise"></span> Regenerate Mesh
            </button>

            <!-- Load FBX Button -->
            <button class="btn btn-outline-secondary w-100 mb-2" @onclick="LoadFbx">
                <span class="bi bi-box-seam"></span> Load FBX Source
            </button>

            <!-- Test Walk Button -->
            <button class="btn @(isWalking ? "btn-danger" : "btn-warning") w-100 mb-4" @onclick="ToggleWalk">
                <span class="bi @(isWalking ? "bi-stop-fill" : "bi-play-fill")"></span> 
                @(isWalking ? "Stop Walking" : "Test Walk (WASD)")
            </button>

            <hr />

            <!-- APPEARANCE SECTION -->
            <h4 class="mb-3">Equipment</h4>

            <div class="mb-3">
                <label class="form-label small">Skin Tone</label>
                <input type="color" class="form-control form-control-color w-100"
                       @bind="recipe.SkinColor" @bind:event="oninput" @onchange="Render" />
            </div>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" checked="@recipe.HasShirt" @onchange="@(async e => { recipe.HasShirt = (bool)(e.Value ?? false); await Render(); })">
                <label class="form-check-label">Shirt</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" checked="@recipe.HasPants" @onchange="@(async e => { recipe.HasPants = (bool)(e.Value ?? false); await Render(); })">
                <label class="form-check-label">Pants</label>
            </div>
            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" checked="@recipe.HasBoots" @onchange="@(async e => { recipe.HasBoots = (bool)(e.Value ?? false); await Render(); })">
                <label class="form-check-label">Boots</label>
            </div>

            <!-- Spacer to push download to bottom -->
            <div style="flex-grow: 1;"></div>

            <!-- FBX CONTROL SECTION -->
            <h4 class="mb-3">Rigged Model Controls</h4>
            
            <div class="mb-3">
                <button class="btn btn-outline-secondary w-100 mb-2" @onclick="LoadFbx">
                    <span class="bi bi-box-seam"></span> Reload Model
                </button>
            </div>

            <div class="mb-3">
                <label class="form-label small">Height Scale: <strong>@customHeight.ToString("0.0")x</strong></label>
                <input type="range" class="form-range" min="0.5" max="2.0" step="0.1"
                       @bind="customHeight" @bind:event="oninput" @onchange="UpdateCustomization" />
            </div>

            <div class="mb-3">
                <label class="form-label small">Width/Weight: <strong>@customWidth.ToString("0.0")x</strong></label>
                <input type="range" class="form-range" min="0.5" max="2.0" step="0.1"
                       @bind="customWidth" @bind:event="oninput" @onchange="UpdateCustomization" />
            </div>

            <div class="mb-3">
                <label class="form-label small">Skin Color</label>
                <input type="color" class="form-control form-control-color w-100"
                       @bind="skinColor" @bind:event="oninput" @onchange="UpdateCustomization" />
            </div>

            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" @bind="xRayMode" @onclick="ToggleXRay">
                <label class="form-check-label">X-Ray Mode (Show Skeleton)</label>
            </div>

            <hr />
            
            <!-- LEGACY SECTION (Collapsed) -->
            <details>
                <summary>Legacy Procedural Controls</summary>
                
                <div class="mb-3 mt-3">
                    <label class="form-label small">Height: <strong>@recipe.HeightCm cm</strong></label>
                    <input type="range" class="form-range" min="140" max="220"
                           @bind="recipe.HeightCm" @bind:event="oninput" @onchange="Render" />
                </div>
                
                <button class="btn btn-primary w-100 mb-2" @onclick="Render">
                    <span class="bi bi-arrow-clockwise"></span> Procedural Mesh
                </button>
            </details>
            
            <div style="flex-grow: 1;"></div>

            <!-- Download Button -->
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-success" @onclick="DownloadGlb">
                    <span class="bi bi-download"></span> Download .GLB
                </button>
            </div>

        </div>

        <!-- 3D Canvas -->
        <div class="col-md-9 p-0">
            <canvas id="renderCanvas" style="width: 100%; height: 90vh; outline: none; display: block;"></canvas>
        </div>
    </div>
</div>

@code {
    private IJSObjectReference? module;
    private HumanoidRecipe recipe = new HumanoidRecipe();
    private bool isWalking = false;
    private bool showAdvanced = false;
    private CancellationTokenSource? walkCts;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/humanoidRenderer.js?v=5");
                await module.InvokeVoidAsync("initCanvas", "renderCanvas");
                await Render();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing 3D Scene: {ex.Message}");
            }
        }
    }

    private async Task ToggleGender()
    {
        recipe.IsMale = !recipe.IsMale;
        await Render();
    }

    private async Task OnRaceChanged(ChangeEventArgs e)
    {
        string race = e.Value?.ToString() ?? "human";
        
        // Reset defaults
        recipe.ShoulderWidthMult = 1.0f;
        recipe.ArmLengthMult = 1.0f;
        recipe.LegLengthMult = 1.0f;
        recipe.TorsoHunch = 0.0f;
        recipe.NeckLengthMult = 1.0f;
        recipe.NeckLengthMult = 1.0f;
        recipe.SkinColor = "#D2B48C"; // Human tan
        recipe.HasShirt = false;
        recipe.HasPants = false;
        recipe.HasBoots = false;

        switch (race)
        {
            case "orc":
                recipe.ShoulderWidthMult = 1.4f;
                recipe.Muscularity = 0.9f;
                recipe.SkinColor = "#4A5D23"; // Orc green
                recipe.TorsoHunch = 0.3f;
                break;
            case "elf":
                recipe.HeightCm = 200f;
                recipe.Obesity = 0.1f;
                recipe.Muscularity = 0.3f;
                recipe.NeckLengthMult = 1.3f;
                recipe.ShoulderWidthMult = 0.9f;
                break;
            case "werewolf":
                recipe.TorsoHunch = 0.8f;
                recipe.ArmLengthMult = 1.3f;
                recipe.Muscularity = 0.8f;
                recipe.SkinColor = "#5C4033"; // Brown fur-like color
                break;
        }

        await Render();
    }

    private async Task Render()
    {
        if (module is not null)
        {
            var bodyParts = HumanoidSolver.Solve(recipe);
            await module.InvokeVoidAsync("renderHumanoid", bodyParts);
        }
    }

    // Customization Variables
    private float customHeight = 1.0f;
    private float customWidth = 1.0f;
    private bool xRayMode = false;
    private string skinColor = "#D2B48C";

    private async Task UpdateCustomization()
    {
        if (module is not null)
        {
            await module.InvokeVoidAsync("setBodyScale", customHeight, customWidth);
            await module.InvokeVoidAsync("setSkinColor", skinColor);
        }
    }

    private async Task ToggleXRay()
    {
        xRayMode = !xRayMode;
        if (module is not null)
        {
            await module.InvokeVoidAsync("setXRayMode", xRayMode);
        }
    }

    private async Task LoadFbx()
    {
        if (module is not null)
        {
            await module.InvokeVoidAsync("loadHumanoidFbx");
            // Apply current customization after load
            await UpdateCustomization();
            if (xRayMode) await module.InvokeVoidAsync("setXRayMode", true);
        }
    }

    private async Task ToggleWalk()
    {
        isWalking = !isWalking;
        if (module is not null)
        {
            await module.InvokeVoidAsync("setAnimationState", isWalking ? "walk" : "idle");
        }
    }
    
    // Legacy Loop Removed

    private async Task DownloadGlb()
    {
        if (module is not null)
        {
            string gender = recipe.IsMale ? "Male" : "Female";
            string filename = $"Human_{gender}_{recipe.HeightCm}cm";
            await module.InvokeVoidAsync("downloadModel", filename);
        }
    }
}