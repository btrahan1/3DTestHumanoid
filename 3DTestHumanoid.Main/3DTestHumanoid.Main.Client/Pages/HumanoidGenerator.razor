@page "/humanoid"
@using _3DTestHumanoid.Main.Client
@using System.Text.Json
@inject IJSRuntime JS

<PageTitle>Humanoid Generator</PageTitle>

<div class="container-fluid">
    <div class="row">
        <!-- Controls Sidebar -->
        <div class="col-md-3 bg-light p-3" style="height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">

            <h4 class="mb-3">Character Recipe</h4>

            <!-- Recipe Name -->
            <div class="mb-3">
                <label class="form-label small">Name</label>
                <input type="text" class="form-control" @bind="recipe.Name" />
            </div>

            <!-- RECIPE ACTIONS -->
            <div class="d-grid gap-2 mb-4">
                 <div class="btn-group">
                    <label class="btn btn-outline-secondary btn-sm" title="Load Recipe (.json)">
                        <span class="bi bi-upload"></span> Load Recipe
                        <InputFile OnChange="OnLoadRecipe" style="display: none;" accept=".json" />
                    </label>
                    <button class="btn btn-outline-primary btn-sm" @onclick="SaveRecipe" title="Save Recipe (.json)">
                        <span class="bi bi-save"></span> Save Recipe
                    </button>
                    <button class="btn btn-outline-danger btn-sm" @onclick="ResetRecipe" title="Reset">
                        <span class="bi bi-arrow-counterclockwise"></span>
                    </button>
                 </div>
            </div>
            
            <hr />

            <!-- AI / PASTEBOARD SECTION -->
            <details class="mb-3">
                <summary class="small">AI / Pasteboard</summary>
                <div class="mt-2">
                    <textarea class="form-control x-small mb-2" rows="5" placeholder="Paste JSON here..." @bind="pasteJson"></textarea>
                    <button class="btn btn-sm btn-outline-primary w-100" @onclick="ApplyPaste">
                        <span class="bi bi-magic"></span> Apply Recipe
                    </button>
                    @if (!string.IsNullOrEmpty(pasteError))
                    {
                        <div class="text-danger x-small mt-1">@pasteError</div>
                    }
                </div>
            </details>

            <hr />

            <!-- APPEARANCE SECTION -->
            <h5 class="mb-3">Equipment</h5>

            <div class="mb-3">
                <label class="form-label small">Skin Tone</label>
                <input type="color" class="form-control form-control-color w-100"
                       @bind="recipe.SkinColor" @bind:event="oninput" @onchange="Render" />
            </div>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" checked="@recipe.HasShirt" @onchange="@(async e => { recipe.HasShirt = (bool)(e.Value ?? false); await Render(); })">
                <label class="form-check-label">Shirt</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" checked="@recipe.HasPants" @onchange="@(async e => { recipe.HasPants = (bool)(e.Value ?? false); await Render(); })">
                <label class="form-check-label">Pants</label>
            </div>
            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" checked="@recipe.HasBoots" @onchange="@(async e => { recipe.HasBoots = (bool)(e.Value ?? false); await Render(); })">
                <label class="form-check-label">Boots</label>
            </div>

            <!-- MORPHOLOGY SECTION -->
            <h5 class="mb-3">Morphology</h5>
            
            <div class="mb-3">
                <label class="form-label small">Height Scale: <strong>@recipe.HeightScale.ToString("0.0")x</strong></label>
                <input type="range" class="form-range" min="0.5" max="2.0" step="0.1"
                       @bind="recipe.HeightScale" @bind:event="oninput" @onchange="Render" />
            </div>

            <div class="mb-3">
                <label class="form-label small">Width/Weight: <strong>@recipe.WidthScale.ToString("0.0")x</strong></label>
                <input type="range" class="form-range" min="0.5" max="2.0" step="0.1"
                       @bind="recipe.WidthScale" @bind:event="oninput" @onchange="Render" />
            </div>
            
            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" @bind="xRayMode" @onclick="ToggleXRay">
                <label class="form-check-label">X-Ray Mode</label>
            </div>

            <div style="flex-grow: 1;"></div>
            
            <!-- MODEL ACTIONS -->
            <h5 class="mb-2">3D Model</h5>
            <div class="d-grid gap-2 mt-auto">
                <button class="btn btn-outline-secondary btn-sm" @onclick="LoadFbx">
                     <span class="bi bi-arrow-repeat"></span> Reset Base Model
                </button>
                
                <label class="btn btn-outline-secondary btn-sm">
                    <span class="bi bi-file-earmark-binary"></span> Import .GLB Mesh
                    <InputFile OnChange="OnLoadGlb" style="display: none;" accept=".glb,.gltf" />
                </label>

                <button class="btn btn-success" @onclick="DownloadGlb">
                    <span class="bi bi-download"></span> Export Model (.GLB)
                </button>
            </div>

        </div>

        <!-- 3D Canvas -->
        <div class="col-md-9 p-0">
            <canvas id="renderCanvas" style="width: 100%; height: 90vh; outline: none; display: block;"></canvas>
        </div>
    </div>
</div>

@code {
    private IJSObjectReference? module;
    private HumanoidRecipe recipe = new HumanoidRecipe();
    private bool isWalking = false;
    private bool xRayMode = false;
    
    // Pasteboard
    private string pasteJson = "";
    private string pasteError = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/humanoidRenderer.js?v=7");
                await module.InvokeVoidAsync("initCanvas", "renderCanvas");
                await Render();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing 3D Scene: {ex.Message}");
            }
        }
    }

    private async Task Render()
    {
        if (module is not null)
        {
            // Update Visuals
            await module.InvokeVoidAsync("renderHumanoid", HumanoidSolver.Solve(recipe));
            await module.InvokeVoidAsync("setBodyScale", recipe.HeightScale, recipe.WidthScale);
            await module.InvokeVoidAsync("setSkinColor", recipe.SkinColor);
        }
    }

    // --- RECIPE MANAGEMENT ---

    private void ResetRecipe()
    {
        recipe = new HumanoidRecipe();
        pasteJson = "";
        pasteError = "";
        StateHasChanged();
        _ = Render();
    }

    private async Task ApplyPaste()
    {
        if (string.IsNullOrWhiteSpace(pasteJson)) return;
        try 
        {
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var newRecipe = JsonSerializer.Deserialize<HumanoidRecipe>(pasteJson, options);
            if (newRecipe != null)
            {
                recipe = newRecipe;
                pasteError = "";
                await Render();
            }
        }
        catch (Exception ex)
        {
            pasteError = "Invalid JSON";
            Console.WriteLine(ex.Message);
        }
    }

    private async Task SaveRecipe()
    {
        var json = JsonSerializer.Serialize(recipe, new JsonSerializerOptions { WriteIndented = true });
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);
        var filename = $"{recipe.Name.Replace(" ", "_")}.json";
        
        // Use module instance for exported functions
        if (module is not null)
        {
            await module.InvokeVoidAsync("downloadFileFromClient", filename, base64);
        }
    }

    private async Task OnLoadRecipe(InputFileChangeEventArgs e)
    {
        try {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            recipe = await JsonSerializer.DeserializeAsync<HumanoidRecipe>(stream) ?? new HumanoidRecipe();
            await Render();
        } catch (Exception ex) {
            Console.WriteLine("Error loading recipe: " + ex.Message);
        }
    }

    // --- MODEL IO ---

    private async Task OnLoadGlb(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        using var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        await module.InvokeVoidAsync("loadGlbModel", ms.ToArray());
    }

    private async Task LoadFbx()
    {
        if (module is not null)
        {
            await module.InvokeVoidAsync("loadHumanoidFbx");
            await Render();
        }
    }

    private async Task DownloadGlb()
    {
        if (module is not null)
        {
            string filename = $"{recipe.Name}_Export";
            await module.InvokeVoidAsync("downloadModel", filename);
        }
    }
    
    // --- VIEW CONTROLS ---

    private async Task ToggleXRay()
    {
        xRayMode = !xRayMode;
        if (module is not null) await module.InvokeVoidAsync("setXRayMode", xRayMode);
    }
}
